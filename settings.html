<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è¨­å®š | ã‚‰ã´ãƒ¬ã‚¸</title>
    <style>
        :root {
            --black: #000000; --white: #ffffff; --gray-bg: #f8f9fa;
            --gray-light: #e9ecef; --accent: #00ff00; --header-h: 60px; --danger: #ff0000;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; touch-action: manipulation; }
        
        body { 
            background-color: var(--gray-bg); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        
        header {
            /* å…ƒã®é«˜ã• 60px ã« ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢åˆ†ã‚’ãƒ—ãƒ©ã‚¹ã™ã‚‹è¨­å®š */
            height: calc(var(--header-h) + env(safe-area-inset-top)); 
            border-bottom: 3px solid var(--black);
            display: flex; 
            align-items: center; 
            /* ä¸‹è¨˜ã®ã‚ˆã†ã« padding-top ã‚’èª¿æ•´ */
            padding: env(safe-area-inset-top) 20px 0 20px; 
            background: var(--white);
            position: sticky; 
            top: 0; 
            z-index: 1100;
            justify-content: space-between;
        }

        .header-left { display: flex; align-items: center; }
        header h1 { font-size: 1.5rem; font-weight: 900; margin-left: 20px; white-space: nowrap; }

        .header-ad-space {
            flex: 1; margin-left: 20px; height: 50px; background: #fff;
            display: flex; align-items: center; justify-content: center;
            border: 1px dashed #ccc; overflow: hidden;
        }
        
        .menu-trigger { width: 30px; height: 22px; cursor: pointer; position: relative; }
        .menu-trigger span { display: block; width: 100%; height: 4px; background: var(--black); position: absolute; left: 0; transition: all 0.3s; }
        .menu-trigger span:nth-child(1) { top: 0; }
        .menu-trigger span:nth-child(2) { top: 9px; }
        .menu-trigger span:nth-child(3) { top: 18px; }
        .menu-trigger.open span:nth-child(1) { transform: translateY(9px) rotate(45deg); }
        .menu-trigger.open span:nth-child(2) { opacity: 0; }
        .menu-trigger.open span:nth-child(3) { transform: translateY(-9px) rotate(-45deg); }

        .side-nav { 
            position: fixed; 
            top: var(--header-h); 
            left: 0; 
            width: 250px; 
            /* ä¿®æ­£ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ†ã‚’å¼•ã„ãŸ100%ã«ã—ã€ã•ã‚‰ã«ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢åˆ†ã‚’ä¸‹ã¾ã§ä¼¸ã°ã™ */
            height: calc(100% - var(--header-h)); 
            padding-bottom: env(safe-area-inset-bottom); 
            background: var(--white); 
            border-right: 3px solid var(--black); 
            z-index: 1050; 
            transition: transform 0.3s; 
            padding-left: 20px;
            padding-right: 20px;
            padding-top: 20px;
        }
        .side-nav.hidden { transform: translateX(-100%); }
        .menu-link { display: block; padding: 15px; color: var(--black); font-weight: 800; text-decoration: none; border-bottom: 1px solid var(--gray-light); }

        .container { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .settings-card {
            width: 100%; max-width: 500px; background: var(--white); border: 4px solid var(--black);
            padding: 25px; box-shadow: 6px 6px 0 var(--black); height: fit-content; margin-bottom: 30px;
        }
        
        label { display: block; font-weight: 900; margin-bottom: 10px; font-size: 1.1rem; }
        input[type="text"], input[type="number"] {
            width: 100%; padding: 12px; border: 3px solid var(--black); font-size: 1rem;
            font-weight: 800; margin-bottom: 25px; outline: none; 
            border-radius: 0; appearance: none; -webkit-appearance: none;
        }
        
        .save-btn {
            width: 100%; background: var(--black); color: var(--white); border: 2px solid var(--black);
            padding: 18px; font-size: 1.1rem; font-weight: 900; cursor: pointer;
            transition: 0.2s; text-align: center; text-decoration: none; display: block;
            border-radius: 0; appearance: none; -webkit-appearance: none;
        }
        .save-btn:active { transform: scale(0.98); }

        /* ãƒ‡ãƒ¼ã‚¿é¸æŠç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .data-selector {
            background: #eee; border: 2px solid #000; padding: 15px; margin-bottom: 20px;
        }
        .data-option {
            display: flex; align-items: center; margin-bottom: 10px; font-weight: 800; cursor: pointer;
        }
        .data-option input { width: 20px; height: 20px; margin-right: 10px; accent-color: #000; cursor: pointer; }

        .drop-zone {
            border: 3px dashed var(--black); padding: 30px; text-align: center;
            font-weight: 800; background: #f0f0f0; cursor: pointer; margin-bottom: 15px;
            transition: background 0.3s;
        }
        .drop-zone.dragover { background: var(--accent); }

        .reset-btn {
            width: 100%; background: var(--white); color: var(--black); border: 3px solid var(--black);
            padding: 15px; font-weight: 900; cursor: pointer; margin-top: 15px; transition: 0.2s;
            border-radius: 0; appearance: none; -webkit-appearance: none;
        }
        .reset-btn:active { transform: scale(0.98); }

        .flex-row { display: flex; gap: 10px; align-items: stretch; margin-bottom: 15px; }
        .flex-row input { margin-bottom: 0; flex: 1; width: 0; }

        @media screen and (max-width: 768px) {
            header { padding: 0 10px; }
            header h1 { font-size: 0.9rem; margin-left: 10px; flex-shrink: 0; }
            .header-ad-space { display: flex !important; flex: 1; margin-left: 10px; height: 35px; min-width: 80px; border: 1px solid #ddd; font-size: 8px; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <div class="menu-trigger" id="menu-btn"><span></span><span></span><span></span></div>
        <h1>è¨­å®š</h1>
    </div>
    <div class="header-ad-space" id="ad-top">
        <span style="color:#ccc; font-size: 8px; font-weight: 900;">AD</span>
    </div>
</header>

<nav class="side-nav hidden" id="side-menu">
    <a href="register.html" class="menu-link">ãƒ¬ã‚¸æ“ä½œ</a>
    <a href="product.html" class="menu-link">å•†å“ç®¡ç†</a>
    <a href="stock.html" class="menu-link">åœ¨åº«ç®¡ç†</a>
    <a href="history.html" class="menu-link">è²©å£²å±¥æ­´</a>
</nav>

<main class="container">
    <div class="settings-card">
        <h3 style="font-weight: 900; border-left: 8px solid #000; padding-left: 10px; margin-bottom: 20px;">åº—èˆ—æƒ…å ±è¨­å®š</h3>
        <label>åº—èˆ—å / ä¼šç¤¾å</label>
        <input type="text" id="companyName" placeholder="ä¾‹ï¼šã‚‰ã´ãƒ¬ã‚¸ ã‚«ãƒ•ã‚§">
        <label>é ˜åæ›¸ç”¨ ä½†ã—æ›¸ãï¼ˆã€‡ã€‡ä»£ã¨ã—ã¦ï¼‰</label>
        <input type="text" id="receiptType" placeholder="ä¾‹ï¼šãŠé£Ÿäº‹ä»£ã€ãŠå“ä»£">
        <label>ä½æ‰€</label>
        <input type="text" id="address" placeholder="æ±äº¬éƒ½ã€‡ã€‡åŒº1-2-3">
        <label>é›»è©±ç•ªå·</label>
        <input type="text" id="tel" placeholder="03-1234-5678">
        <label>ä¸€è¨€ãƒ¡ãƒ¢</label>
        <input type="text" id="memo" placeholder="ã”æ¥åº—ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼">
        <button id="saveProfileBtn" class="save-btn">åº—èˆ—æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div class="settings-card">
        <h3 style="font-weight: 900; margin-bottom: 20px; border-left: 8px solid #000; padding-left: 10px;">æ±ºæ¸ˆæ–¹æ³•ï¼ˆæœ€å¤§5ã¤ï¼‰</h3>
        <div id="paymentMethodsContainer">
            <input type="text" class="payment-input" placeholder="æ±ºæ¸ˆ1 (ä¾‹: ç¾é‡‘)">
            <input type="text" class="payment-input" placeholder="æ±ºæ¸ˆ2 (ä¾‹: ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ)">
            <input type="text" class="payment-input" placeholder="æ±ºæ¸ˆ3 (ä¾‹: ã‚³ãƒ¼ãƒ‰æ±ºæ¸ˆ)">
            <input type="text" class="payment-input" placeholder="æ±ºæ¸ˆ4">
            <input type="text" class="payment-input" placeholder="æ±ºæ¸ˆ5">
        </div>
        <button id="savePaymentBtn" class="save-btn">æ±ºæ¸ˆæ–¹æ³•ã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div class="settings-card">
        <h3 style="font-weight: 900; margin-bottom: 20px; border-left: 8px solid #000; padding-left: 10px;">å‰²å¼•è¨­å®šï¼ˆåŠè§’ã§å…¥åŠ›ï¼‰</h3>
        <div id="discountContainer">
            <div class="flex-row">
                <input type="text" class="discount-name" placeholder="åç§°1">
                <input type="text" class="discount-value" placeholder="é‡‘é¡ï¼ˆï¼…ã‚‚å¯ï¼‰">
            </div>
            <div class="flex-row">
                <input type="text" class="discount-name" placeholder="åç§°2">
                <input type="text" class="discount-value" placeholder="é‡‘é¡ï¼ˆï¼…ã‚‚å¯ï¼‰">
            </div>
            <div class="flex-row">
                <input type="text" class="discount-name" placeholder="åç§°3">
                <input type="text" class="discount-value" placeholder="é‡‘é¡ï¼ˆï¼…ã‚‚å¯ï¼‰">
            </div>
        </div>
        <button id="saveDiscountBtn" class="save-btn">å‰²å¼•è¨­å®šã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div class="settings-card">
        <h3 style="font-weight: 900; margin-bottom: 20px; border-left: 8px solid #000; padding-left: 10px;">ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
        
        <label>æ“ä½œå¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ</label>
        <div class="data-selector" id="dataSelector">
            <label class="data-option"><input type="checkbox" value="products" checked> å•†å“ï¼‹ã‚«ãƒ†ã‚´ãƒª</label>
            <label class="data-option"><input type="checkbox" value="history" checked> è²©å£²å±¥æ­´</label>
            <label class="data-option"><input type="checkbox" value="profile" checked> åº—èˆ—æƒ…å ±</label>
            <label class="data-option"><input type="checkbox" value="payments" checked> æ±ºæ¸ˆæ‰‹æ®µ</label>
            <label class="data-option"><input type="checkbox" value="discounts" checked> å‰²å¼•æƒ…å ±</label>
            <label class="data-option"><input type="checkbox" value="stock" checked> åœ¨åº«æƒ…å ±</label>
        </div>

        <label>ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãå‡ºã—</label>
        <button id="exportBtn" class="save-btn" style="margin-bottom: 25px; background: #fff; color: #000;">é¸æŠã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
        
        <label>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</label>
        <div id="dropZone" class="drop-zone">ã“ã“ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
        <input type="file" id="fileInput" style="display: none;" accept=".json">
    </div>

    <div class="settings-card" style="border-color: #000; background: #fff;">
        <h3 style="font-weight: 900; margin-bottom: 10px; border-left: 8px solid #000; padding-left: 10px;">ğŸ’¡ ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„</h3>
        <p style="font-size: 0.8rem; font-weight: 800; margin-bottom: 15px;">ä¸å…·åˆå ±å‘Šã‚„æ–°æ©Ÿèƒ½ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã“ã¡ã‚‰ã‹ã‚‰ãŠé€ã‚Šãã ã•ã„ã€‚</p>
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSfvlhXZz0kiJ03ii4lFBBtK8QY3Q54M1ykejPiV0uDl8fR2SA/viewform?usp=header" target="_blank" class="save-btn" style="background: #fff; color: #000; border: 3px solid #000;">ã”æ„è¦‹ãƒ»ã”è¦æœ›ã‚’é€ã‚‹</a>
    </div>

    <div class="settings-card" style="border-color: #000; box-shadow: 6px 6px 0 var(--black);">
        <h3 style="color: var(--black); font-weight: 900; margin-bottom: 10px; border-left: 8px solid var(--black); padding-left: 10px;">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</h3>
        <button id="resetSalesBtn" class="reset-btn">è²©å£²å±¥æ­´ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="resetProductsBtn" class="reset-btn">å•†å“ãƒ»ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="resetAllDataBtn" class="reset-btn">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    
</main>

<script>
    const STORAGE_KEYS = {
        profile: ['rapireji_profile'],
        payments: ['rapireji_payments'],
        discounts: ['rapireji_discounts'],
        products: ['rapireji_products', 'rapireji_categories'],
        history: ['rapireji_history'],
        stock: ['rapireji_stock_config']
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadLocalSettings();
        initBackupSystem();
    });

    function loadLocalSettings() {
        const profile = JSON.parse(localStorage.getItem('rapireji_profile') || '{}');
        document.getElementById('companyName').value = profile.companyName || "";
        document.getElementById('receiptType').value = profile.receiptType || "";
        document.getElementById('address').value = profile.address || "";
        document.getElementById('tel').value = profile.tel || "";
        document.getElementById('memo').value = profile.memo || "";

        const payments = JSON.parse(localStorage.getItem('rapireji_payments') || '["ç¾é‡‘", "äº¤é€šç³»IC", "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰", "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ±ºæ¸ˆ", "ãã®ä»–"]');
        document.querySelectorAll('.payment-input').forEach((el, i) => el.value = payments[i] || "");

        // å‰²å¼•è¨­å®šã®èª­ã¿è¾¼ã¿ï¼ˆ%è¡¨ç¤ºã®å¾©å…ƒï¼‰
        const discounts = JSON.parse(localStorage.getItem('rapireji_discounts') || '[]');
        const nameInputs = document.querySelectorAll('.discount-name');
        const valueInputs = document.querySelectorAll('.discount-value');
        nameInputs.forEach((el, i) => {
            const item = discounts[i];
            if (item) {
                el.value = item.name || "";
                valueInputs[i].value = item.isPercent ? `${item.value}%` : (item.value || "");
            }
        });
    }

    function initBackupSystem() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†
        document.getElementById('exportBtn').onclick = () => {
            const selectedTypes = Array.from(document.querySelectorAll('#dataSelector input:checked')).map(cb => cb.value);
            if (selectedTypes.length === 0) return alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„");

            const backupData = { _rapireji_version: "2.0", _exported_at: new Date().toISOString() };
            
            selectedTypes.forEach(type => {
                STORAGE_KEYS[type].forEach(key => {
                    const val = localStorage.getItem(key);
                    if (val) backupData[key] = val;
                });
            });

            const blob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rapireji_data_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragover');
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
        fileInput.onchange = (e) => handleFile(e.target.files[0]);
    }

    function handleFile(file) {
        if (!file || file.type !== "application/json") return alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");

        const selectedTypes = Array.from(document.querySelectorAll('#dataSelector input:checked')).map(cb => cb.value);
        if (selectedTypes.length === 0) return alert("å¾©å…ƒå¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„");

        if (!confirm("é¸æŠã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚")) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                let count = 0;

                selectedTypes.forEach(type => {
                    STORAGE_KEYS[type].forEach(key => {
                        if (data[key]) {
                            localStorage.setItem(key, data[key]);
                            count++;
                        }
                    });
                });

                if (count > 0) {
                    alert("é¸æŠã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
                    location.reload();
                } else {
                    alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã«é¸æŠã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                }
            } catch (err) {
                alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        };
        reader.readAsText(file);
    }

    // ä¿å­˜ãƒœã‚¿ãƒ³ãƒ»ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    document.getElementById('saveProfileBtn').onclick = () => {
        const data = {
            companyName: document.getElementById('companyName').value,
            receiptType: document.getElementById('receiptType').value,
            address: document.getElementById('address').value,
            tel: document.getElementById('tel').value,
            memo: document.getElementById('memo').value
        };
        localStorage.setItem('rapireji_profile', JSON.stringify(data));
        alert("åº—èˆ—æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    };

    document.getElementById('savePaymentBtn').onclick = () => {
        const methods = Array.from(document.querySelectorAll('.payment-input')).map(el => el.value).filter(v => v !== "");
        localStorage.setItem('rapireji_payments', JSON.stringify(methods));
        alert("æ±ºæ¸ˆæ–¹æ³•ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    };

    document.getElementById('saveDiscountBtn').onclick = () => {
        const items = [];
        const nameInputs = document.querySelectorAll('.discount-name');
        const valueInputs = document.querySelectorAll('.discount-value');

        nameInputs.forEach((el, i) => {
            const rawValue = valueInputs[i].value.trim(); 
            
            if (el.value && rawValue !== "") {
                const isPercent = rawValue.includes('%');
                const numValue = parseFloat(rawValue.replace('%', ''));

                if (!isNaN(numValue)) {
                    items.push({ 
                        name: el.value, 
                        value: numValue,
                        isPercent: isPercent 
                    });
                }
            }
        });
        localStorage.setItem('rapireji_discounts', JSON.stringify(items));
        alert("å‰²å¼•è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    };

    document.getElementById('resetSalesBtn').onclick = () => { if(confirm("è²©å£²å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) localStorage.removeItem('rapireji_history'); };
    document.getElementById('resetProductsBtn').onclick = () => { if(confirm("å•†å“ãƒ»ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('rapireji_products'); localStorage.removeItem('rapireji_categories'); } };
    document.getElementById('resetAllDataBtn').onclick = () => { if(confirm("ã™ã¹ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); } };

    const menuBtn = document.getElementById('menu-btn');
    const sideMenu = document.getElementById('side-menu');
    menuBtn.onclick = () => { menuBtn.classList.toggle('open'); sideMenu.classList.toggle('hidden'); };
</script>
</body>
</html>
